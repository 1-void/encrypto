name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install Rust components
      run: rustup component add rustfmt clippy
    - name: Bootstrap PQC OpenSSL
      run: ./scripts/bootstrap-pqc.sh
    - name: Build, fmt, clippy, and test (PQC)
      run: |
        set -euo pipefail
        source scripts/pqc-env.sh
        cargo fmt --check
        cargo clippy --workspace --all-targets -- -D warnings
        cargo build --verbose
        cargo run -p encrypto-cli -- doctor
        cargo test --verbose

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Determine version
      id: version
      run: |
        set -euo pipefail
        version=$(awk -F' *= *' '$1=="version"{gsub(/"/,"",$2); print $2; exit}' encrypto-cli/Cargo.toml)
        if [[ -z "$version" || "$version" == "null" ]]; then
          echo "failed to resolve version from encrypto-cli" >&2
          exit 1
        fi
        echo "version=$version" >> "$GITHUB_OUTPUT"
    - name: Check version bump
      id: bump
      run: |
        set -euo pipefail
        range="${{ github.event.before }}..${{ github.sha }}"
        if git diff --name-only "$range" -- encrypto-cli/Cargo.toml | grep -q .; then
          if git diff -U0 "$range" -- encrypto-cli/Cargo.toml | \
             grep -E '^[+-]version = "' >/dev/null; then
            echo "release=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
        fi
        echo "release=false" >> "$GITHUB_OUTPUT"
    - name: Create tag and release
      if: steps.bump.outputs.release == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        version="${{ steps.version.outputs.version }}"
        tag="v${version}"
        git fetch --tags
        if git rev-parse "$tag" >/dev/null 2>&1; then
          echo "tag $tag already exists; skipping release"
          exit 0
        fi
        gh release create "$tag" --generate-notes
